# Soccer-AI Checkpoint #2
**Generated:** 2025-12-28 07:00 UTC
**Purpose:** Complete architecture model for session continuity

---

## Quick Resume Command
```
Load CHECKPOINT_02_20251228.md and ARCHITECTURE.mmd - you are resuming Soccer-AI development.
```

---

## Project Overview

Soccer-AI is a Premier League knowledge base with:
- **20 Fan Personas** - Chat as any club's supporter
- **Tri-Lens Predictor** - Match predictions (53.2% accuracy, 17.3% draw detection)
- **Knowledge Graph** - 500+ node NLKE-compliant graph
- **RAG Pipeline** - Context-aware responses via Gemini

---

## Architecture Summary

```
┌─────────────────────────────────────────────────────────────────┐
│                    USER (Web Browser)                           │
└────────────────────────┬────────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────────┐
│              FLASK FRONTEND [:5000]                             │
│  app.py → templates/ → static/                                  │
│  Routes: /, /chat, /predictions, /standings, /fixtures, /teams │
└────────────────────────┬────────────────────────────────────────┘
                         │ HTTP/JSON
┌────────────────────────▼────────────────────────────────────────┐
│              FASTAPI BACKEND [:8000]                            │
│  main.py → database.py → rag.py → ai_response.py               │
│  Endpoints: /api/v1/{chat,tri-lens,standings,fixtures,teams}   │
└────────────────────────┬────────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────────┐
│              PREDICTOR MODULE                                   │
│  tri_lens_predictor.py (55% Poisson + 45% Oracle)              │
│  poisson_predictor.py → hybrid_oracle.py → team_ratings.py     │
└────────────────────────┬────────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────────┐
│              DATABASES                                          │
│  soccer_ai.db       - Main knowledge base (teams, players)     │
│  predictor_facts.db - Match facts for predictions              │
│  soccer_ai_kg.db    - Knowledge graph nodes/edges              │
└─────────────────────────────────────────────────────────────────┘
```

---

## File Locations

### Flask Frontend (`flask-frontend/`)
| File | Purpose | Key Functions |
|------|---------|---------------|
| `app.py` | Flask application | Routes: /, /chat, /predictions, /standings, /fixtures, /teams |
| `templates/base.html` | Base template | Header, nav, footer |
| `templates/index.html` | Home page | 20 club persona cards |
| `templates/chat.html` | Fan chat | POST to /api/v1/chat |
| `templates/predictions.html` | Predictor UI | POST to /api/v1/tri-lens/predict |
| `templates/standings.html` | League table | GET /api/v1/standings |
| `templates/fixtures.html` | Games list | GET /api/v1/fixtures |
| `templates/teams.html` | Team browser | GET /api/v1/teams |
| `static/app.js` | Frontend logic | API calls, DOM updates |
| `static/style.css` | Styling | Club colors, responsive layout |

### Backend (`backend/`)
| File | Purpose | Key Exports |
|------|---------|-------------|
| `main.py` | FastAPI app | `app`, all endpoints |
| `database.py` | SQLite + FTS5 | `get_connection()`, `get_teams()`, `search_fts()` |
| `rag.py` | Context retrieval | `build_context()`, `extract_entities()` |
| `ai_response.py` | LLM integration | `generate_response()`, `sanitize_input()`, `validate_response()` |
| `models.py` | Pydantic schemas | `ChatRequest`, `ApiResponse`, `TeamDetail` |
| `conversation_intelligence.py` | Memory system | `FluentConversation`, `get_enriched_context()` |
| `security_session.py` | Session security | Rate limiting, validation |
| `kg_integration.py` | KG bridge | `get_kg()`, `query_knowledge_graph()` |

### Backend KG Layer (`backend/kg/`)
| File | Purpose | Key Exports |
|------|---------|-------------|
| `kg_database.py` | Graph DB | `KnowledgeGraphDB`, `get_node()`, `search_nodes()` |
| `kg_types.py` | Type definitions | `Node`, `Edge`, `NodeType` |
| `schema.py` | Graph schema | Node/edge schemas |
| `nlke_bridge.py` | NLKE integration | Cross-domain queries |
| `kg_compat.py` | Compatibility | Legacy support |

### Predictor Module (`backend/predictor/`)
| File | Purpose | Key Exports |
|------|---------|-------------|
| `__init__.py` | Package init | All public exports |
| `tri_lens_predictor.py` | **Main predictor** | `TriLensPredictor`, `TriLensPrediction` |
| `poisson_predictor.py` | xG-based Poisson | `PoissonPredictor`, `poisson_probability()`, `calculate_match_probabilities()` |
| `hybrid_oracle.py` | ELO + patterns | `HybridOracle`, `normalize_team_name()` |
| `team_ratings.py` | ELO system | `TeamRatingSystem`, `expected_score()` |
| `draw_detector.py` | Draw analysis | `analyze_draw_probability()`, `enhanced_predict()` |
| `prediction_engine.py` | Two-sided logic | `PredictionEngine`, `Prediction` |
| `side_a_calculator.py` | Favorite weakness | `SideACalculator`, `FactorResult` |
| `side_b_calculator.py` | Underdog strength | `SideBCalculator` |
| `analyst_persona.py` | The Analyst voice | `TheAnalyst`, `AnalystResponse` |
| `statistical_predictor.py` | Stats engine | Statistical analysis |
| `predictor_db.py` | Facts database | `PredictorDB` |
| `data_ingestion.py` | Data pipeline | Ingestion utilities |
| `api.py` | Predictor endpoints | `PredictorAPI`, `quick_predict()` |
| `test_tri_lens.py` | Test suite | 35 tests (all passing) |
| `IMPORT_PATTERNS.md` | Documentation | Import fix guide |

---

## API Endpoints

### Chat
```
POST /api/v1/chat
Body: { "message": "...", "club": "arsenal", "conversation_id": "..." }
Response: { "response": "...", "sources": [...] }
```

### Tri-Lens Prediction
```
POST /api/v1/tri-lens/predict
Body: { "home_team": "Liverpool", "away_team": "Arsenal" }
Response: {
  "prediction": "home_win",
  "probabilities": { "home_win": 0.53, "draw": 0.22, "away_win": 0.25 },
  "expected_goals": { "home": 2.36, "away": 1.03 },
  "likely_scores": [...],
  "upset_analysis": { "risk": 0.48, "patterns": [...] }
}
```

### Other Endpoints
```
GET /api/v1/standings?league=premier_league
GET /api/v1/fixtures?days=7
GET /api/v1/teams
GET /api/v1/teams/{team_id}
GET /health
```

---

## Databases

| Database | Path | Purpose |
|----------|------|---------|
| `soccer_ai.db` | `backend/` | Teams, players, games, facts |
| `predictor_facts.db` | `backend/` | Match history for predictions |
| `soccer_ai_kg.db` | `backend/` | Knowledge graph (nodes, edges) |
| `soccer_ai_architecture_kg.db` | `./` | Architecture documentation |

---

## Tri-Lens Predictor Details

### Algorithm
```
Final = 0.55 × Poisson + 0.45 × Oracle

Poisson Lens:
- home_xg = league_avg × home_attack × away_defense
- P(H,D,A) via Poisson distribution

Oracle Lens:
- ELO-based expected scores
- Pattern detection (form, H2H, fatigue)

Draw Boost:
- Applied when: diff < 0.30 AND upset_risk > 0.40 AND oracle_draw > 0.23
- Boost: +7% to draw probability
```

### Performance
- Overall accuracy: 53.2%
- Draw detection: 17.3%
- Brier score: 0.5799
- Lens agreement tracked (1-3)

---

## Security & Validation

### Input Sanitization (`ai_response.py`, `tri_lens_predictor.py`)
```python
def sanitize_input(text, max_length=2000):
    text = text.replace('\x00', '')  # Remove null bytes
    text = ''.join(c for c in text if c.isprintable() or c in '\n\t')
    return text[:max_length].strip()
```

### Output Validation
```python
def validate_response(response):
    # Length limiting
    if len(response) > 10000:
        response = response[:10000] + "..."
    # Leak detection
    if "system prompt" in response.lower():
        response = response[:idx] + " [truncated]"
    return response
```

### Import Pattern Fix
```python
# At top of predictor files:
import sys
from pathlib import Path
_predictor_dir = Path(__file__).parent
if str(_predictor_dir) not in sys.path:
    sys.path.insert(0, str(_predictor_dir))
```

---

## Test Coverage

| Test File | Tests | Status |
|-----------|-------|--------|
| `predictor/test_tri_lens.py` | 35 | All passing |

Categories: Imports, Poisson Math, Match Probabilities, Input Validation, Security (SQL injection, XSS, null bytes, path traversal), Integration, Regression, Defensive Programming

---

## Startup Commands

```bash
# Start both servers
cd /storage/emulated/0/Download/synthesis-rules/soccer-AI
bash start.sh

# Or manually:
cd backend && uvicorn main:app --host 0.0.0.0 --port 8000 --reload &
cd flask-frontend && python app.py &

# Run predictor tests
cd backend && python predictor/test_tri_lens.py

# Test API
curl http://localhost:8000/health
python3 -c "import requests; print(requests.post('http://localhost:8000/api/v1/tri-lens/predict', json={'home_team':'Liverpool','away_team':'Arsenal'}).json())"
```

---

## Recent Changes (Dec 28, 2025)

1. **Created Tri-Lens Predictor** - Fusion of Poisson + Oracle + Draw boost
2. **Fixed import paths** - Added sys.path manipulation for cross-imports
3. **Added input validation** - Null byte, length, control char filtering
4. **Added output validation** - Leak detection, length limits
5. **Created test suite** - 35 comprehensive tests
6. **Documented patterns** - IMPORT_PATTERNS.md

---

## Pending Work

- [ ] Real-time odds integration
- [ ] Live match updates via Football-Data API
- [ ] Expand draw detection patterns
- [ ] Mobile responsiveness improvements
- [ ] WebSocket for live chat

---

## Key Insights Logged

| Insight | Description |
|---------|-------------|
| #1037 | Poisson achieves best Brier but 0% draw detection |
| #1038 | Weighted ensemble = 1.16 draw improvement factor |
| #1039 | Draw detection vs overall accuracy is a trade-off |

---

## Files for Full Context

To fully understand this codebase, read:
1. `backend/main.py` - All API endpoints
2. `backend/predictor/tri_lens_predictor.py` - Prediction algorithm
3. `backend/ai_response.py` - Chat response generation
4. `flask-frontend/app.py` - Frontend routes
5. `ARCHITECTURE.mmd` - Visual diagram
